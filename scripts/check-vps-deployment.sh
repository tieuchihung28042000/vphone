#!/bin/bash

echo "ğŸ” KIá»‚M TRA DEPLOYMENT TRÃŠN VPS"
echo "================================"

echo "ğŸ“‹ HÆ¯á»šNG DáºªN: Cháº¡y cÃ¡c lá»‡nh nÃ y trÃªn VPS Ä‘á»ƒ kiá»ƒm tra:"
echo ""

echo "1. Kiá»ƒm tra git status trÃªn VPS:"
echo "cd ~/sites/nguyenkieuanh.com"
echo "git status"
echo "git log --oneline -3"
echo ""

echo "2. Kiá»ƒm tra file auth.js Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t chÆ°a:"
echo "grep -n 'username.*trim' backend/routes/auth.js"
echo "# Pháº£i tháº¥y dÃ²ng: username: (username && username.trim()) ? username.trim() : null"
echo ""

echo "3. Náº¿u chÆ°a cÃ³, pull code má»›i:"
echo "git pull origin main"
echo ""

echo "4. Rebuild containers:"
echo "docker-compose down"
echo "docker-compose build --no-cache"
echo "docker-compose up -d"
echo ""

echo "5. Test sau khi rebuild:"
echo "curl -X POST https://nguyenkieuanh.com/api/auth/register \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d '{"
echo "    \"email\": \"testuser\$(date +%s)@vphone.com\","
echo "    \"password\": \"123456\","
echo "    \"full_name\": \"Test User\","
echo "    \"role\": \"admin\","
echo "    \"branch_id\": \"686783939535a971dfe22f4f\""
echo "  }'"
echo ""

echo "ğŸ¯ Káº¾T QUáº¢ MONG Äá»¢I:"
echo "================================"
echo "âœ… git log pháº£i tháº¥y commit: 'Add: HÆ°á»›ng dáº«n deploy cuá»‘i cÃ¹ng vá»›i phÃ¢n quyá»n hoÃ n chá»‰nh'"
echo "âœ… grep pháº£i tháº¥y: 'username: (username && username.trim()) ? username.trim() : null'"
echo "âœ… Táº¡o user pháº£i thÃ nh cÃ´ng: '{\"message\":\"âœ… Táº¡o tÃ i khoáº£n thÃ nh cÃ´ng\"}'"
echo ""

echo "ğŸš¨ Náº¾U VáºªN Lá»–I:"
echo "================================"
echo "1. Kiá»ƒm tra git remote: git remote -v"
echo "2. Force pull: git reset --hard origin/main"
echo "3. Clear docker cache: docker system prune -a"
echo "4. Rebuild tá»« Ä‘áº§u: docker-compose build --no-cache"
echo ""

echo "ğŸ“ DEBUG INFO Cáº¦N Gá»¬I:"
echo "================================"
echo "Náº¿u váº«n lá»—i, hÃ£y gá»­i káº¿t quáº£ cá»§a:"
echo "1. git log --oneline -3"
echo "2. grep -n 'username.*trim' backend/routes/auth.js"
echo "3. docker logs vphone-backend --tail 20"
echo "4. curl test user creation" 